params:
  settlementId:
    required: true
  fspid:
    required: true

data:
  dfspInfo: SELECT participantId, name FROM participant WHERE name = :fspid AND name != 'Hub'
  report: |
    SELECT
        pCPayer.participantId as payerFspid,
        pPayer.name as payerFspName,
        pCPayee.participantId as payeeFspid,
        pPayee.name as payeeFspName,
        tF.transferId,
        tS.name as transactionType,
        tSS.name as transactionNature,
        tF.completedDate as lastModifiedDate,
        pITPayer.name as payerIdentifierType,
        qpPayer.partyIdentifierValue as payerIdentifierValue,
        pITPayee.name as payeeIdentifierType,
        qpPayee.partyIdentifierValue as payeeIdentifierValue,
        t.amount as amount,
        c.currencyId,
        s.settlementId,
        s.createdDate as settlementCreatedDate,
        sSW.settlementWindowId
    FROM
        transferFulfilment tF
        INNER JOIN transfer t ON t.transferId = tF.transferId
        INNER JOIN transferParticipant tPPayer ON tPPayer.transferId = tF.transferId
            AND tPPayer.transferParticipantRoleTypeId = (SELECT transferParticipantRoleTypeId from transferParticipantRoleType WHERE name = 'PAYER_DFSP')
            INNER JOIN participantCurrency pCPayer ON pCPayer.participantCurrencyId = tPPayer.participantCurrencyId
            INNER JOIN participant pPayer ON pPayer.participantId = pCPayer.participantId
        INNER JOIN transferParticipant tPPayee ON tPPayee.transferId = tF.transferId
            AND tPPayee.transferParticipantRoleTypeId = (SELECT transferParticipantRoleTypeId from transferParticipantRoleType WHERE name = 'PAYEE_DFSP')
            INNER JOIN participantCurrency pCPayee ON pCPayee.participantCurrencyId = tPPayee.participantCurrencyId
            INNER JOIN participant pPayee ON pPayee.participantId = pCPayee.participantId
        INNER JOIN settlementWindow sW on sW.settlementWindowId = tF.settlementWindowId
        INNER JOIN settlementSettlementWindow sSW on tF.settlementWindowId = sSW.settlementWindowId
        INNER JOIN settlementWindowStateChange sWSC on sW.currentStateChangeId = sWSC.settlementWindowStateChangeId
        INNER JOIN settlement s on sSW.settlementId = s.settlementId
        INNER JOIN settlementModel sM ON sM.settlementModelId = s.settlementModelId
        INNER JOIN currency c ON c.currencyId = sM.currencyId
        INNER JOIN quote q on q.transactionReferenceId = tF.transferId
        INNER JOIN quoteParty qpPayer on qpPayer.quoteId = q.quoteId AND qpPayer.partyTypeId = (SELECT partyTypeId FROM partyType WHERE name = 'PAYER')
            INNER JOIN partyIdentifierType pITPayer ON pITPayer.partyIdentifierTypeId = qpPayer.partyIdentifierTypeId
        INNER JOIN quoteParty qpPayee on qpPayee.quoteId = q.quoteId AND qpPayee.partyTypeId = (SELECT partyTypeId FROM partyType WHERE name = 'PAYEE')
            INNER JOIN partyIdentifierType pITPayee ON pITPayee.partyIdentifierTypeId = qpPayee.partyIdentifierTypeId
        INNER JOIN transactionScenario tS on tS.transactionScenarioId = q.transactionScenarioId
        LEFT JOIN transactionSubScenario tSS on tSS.transactionSubScenarioId = q.transactionSubScenarioId
    WHERE
        tF.isValid
        AND s.settlementId = :settlementId
        AND (pPayee.name = :fspid OR pPayer.name = :fspid)


